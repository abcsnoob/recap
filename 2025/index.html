<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recap 2025 - Abc's Noob</title>
  <style>
    body {
      font-family: Comfortaa, Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .actions {
      margin-top: 10px;
    }
    .actions button {
      margin-right: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .comments {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .comments input {
      width: 70%;
      padding: 6px;
      margin-top: 8px;
    }
    .comments button {
      padding: 6px 10px;
      margin-left: 6px;
    }
    .spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 40px;
    }
    .spinner div {
      width: 12px;
      height: 12px;
      margin: 4px;
      border-radius: 50%;
      background: #333;
      animation: bounce 0.6s infinite alternate;
    }
    .spinner div:nth-child(2) {
      animation-delay: 0.2s;
    }
    .spinner div:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      to {
        opacity: 0.3;
        transform: translateY(-8px);
      }
    }
  </style>
</head>
<body>
  <h1>üî• Recap 2025 - Abc's Noob</h1>
  <div id="content">
    <div class="spinner"><div></div><div></div><div></div></div>
  </div>
  <div id="loadMoreTrigger" style="height:50px;"></div>


  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js"></script>

  <script>
    // ‚ö†Ô∏è THAY ƒêO·∫†N CONFIG N√ÄY B·∫∞NG FIREBASE C·ª¶A B·∫†N
  const firebaseConfig = {
    apiKey: "AIzaSyAXw6BY4U6VLlwoaKnlrzCzOHKaww6KZN8",
    authDomain: "abcsnoobrecap2025.firebaseapp.com",
    projectId: "abcsnoobrecap2025",
    storageBucket: "abcsnoobrecap2025.firebasestorage.app",
    messagingSenderId: "289987914307",
    appId: "1:289987914307:web:aef1e2497d901be37442f6",
    measurementId: "G-9H1PVE7SHZ"
  };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const contentDiv = document.getElementById("content");
    let lastVisible = null;
    let loading = false;
    const batchSize = 5;

    async function loadMore() {
      if (loading) return;
      loading = true;

      let query = db.collection("dramas")
        .orderBy("title")
        .limit(batchSize);

      if (lastVisible) {
        query = query.startAfter(lastVisible);
      }

      const snapshot = await query.get();

      if (snapshot.empty) {
        document.getElementById("loadMoreTrigger").innerHTML = "<p style='text-align:center;color:#666'>H·∫øt drama r·ªìi üòÖ</p>";
        return;
      }

      lastVisible = snapshot.docs[snapshot.docs.length - 1];

      snapshot.forEach(doc => {
        const item = doc.data();
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <h2>${item.title}</h2>
          ${item.body}
          <div class="actions">
            <button onclick="like('${doc.id}')">üëç ${item.likes || 0}</button>
            <button onclick="dislike('${doc.id}')">üëé ${item.dislikes || 0}</button>
          </div>
          <div class="comments" id="comments-${doc.id}">
            <h4>B√¨nh lu·∫≠n</h4>
            ${item.comments ? item.comments.map(c => `<p><b>${c.user}:</b> ${c.text}</p>`).join("") : ""}
            <input type="text" id="input-${doc.id}" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
            <button onclick="addComment('${doc.id}')">G·ª≠i</button>
          </div>
        `;
        contentDiv.appendChild(div);
      });

      loading = false;
    }

    async function like(id) {
      const ref = db.collection("dramas").doc(id);
      await ref.update({ likes: firebase.firestore.FieldValue.increment(1) });
      reload();
    }

    async function dislike(id) {
      const ref = db.collection("dramas").doc(id);
      await ref.update({ dislikes: firebase.firestore.FieldValue.increment(1) });
      reload();
    }

    async function addComment(id) {
      const input = document.getElementById("input-" + id);
      const text = input.value.trim();
      if (text !== "") {
        const ref = db.collection("dramas").doc(id);
        await ref.update({
          comments: firebase.firestore.FieldValue.arrayUnion({ user: "Kh√°ch", text })
        });
        input.value = "";
        reload();
      }
    }

    function reload() {
      contentDiv.innerHTML = "";
      lastVisible = null;
      loadMore();
    }

    // Lazy load trigger
    const observer = new IntersectionObserver(entries => {
      if (entries[0].isIntersecting) {
        loadMore();
      }
    });
    observer.observe(document.getElementById("loadMoreTrigger"));

    // Load batch ƒë·∫ßu ti√™n
    loadMore();
  </script>
</body>
</html>
