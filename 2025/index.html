<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recap 2025 - Abc's Noob</title>
  <style>
    body {
      font-family: Comfortaa, Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .actions {
      margin-top: 10px;
    }
    .actions button {
      margin-right: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    .comments {
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .comments input {
      width: 70%;
      padding: 6px;
      margin-top: 8px;
    }
    .comments button {
      padding: 6px 10px;
      margin-left: 6px;
    }
    .spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 40px;
    }
    .spinner div {
      width: 12px;
      height: 12px;
      margin: 4px;
      border-radius: 50%;
      background: #333;
      animation: bounce 0.6s infinite alternate;
    }
    .spinner div:nth-child(2) {
      animation-delay: 0.2s;
    }
    .spinner div:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes bounce {
      to {
        opacity: 0.3;
        transform: translateY(-8px);
      }
    }
  </style>
</head>
<body>
<h1>AbcsnoobRecap2025:)</h1>
  <div id="content">
    <div class="spinner"><div></div><div></div><div></div></div>
  </div>
  <div id="loadMoreTrigger" style="height:50px;"></div>


<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
  // ⚠️ Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAXw6BY4U6VLlwoaKnlrzCzOHKaww6KZN8",
    authDomain: "abcsnoobrecap2025.firebaseapp.com",
    projectId: "abcsnoobrecap2025",
    storageBucket: "abcsnoobrecap2025.firebasestorage.app",
    messagingSenderId: "289987914307",
    appId: "1:289987914307:web:aef1e2497d901be37442f6",
    measurementId: "G-9H1PVE7SHZ"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const contentDiv = document.getElementById("content");

  // 👉 Hàm format "x phút/giờ/ngày trước"
  function timeAgo(date) {
    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);

    const intervals = [
      { label: "năm", seconds: 31536000 },
      { label: "tháng", seconds: 2592000 },
      { label: "tuần", seconds: 604800 },
      { label: "ngày", seconds: 86400 },
      { label: "giờ", seconds: 3600 },
      { label: "phút", seconds: 60 }
    ];

    for (const interval of intervals) {
      const count = Math.floor(seconds / interval.seconds);
      if (count >= 1) return `${count} ${interval.label} trước`;
    }
    return "Vừa xong";
  }

  // 👉 Render 1 drama
  function renderDrama(doc) {
    const item = doc.data();

    let dateStr = "Không rõ";
    if (item.createdAt?.toDate) {
      dateStr = timeAgo(item.createdAt.toDate());
    }

    const div = document.createElement("div");
    div.className = "card";
    div.id = "drama-" + doc.id;
    div.innerHTML = `
      <h2>${item.title}</h2>
      ${item.body}
      <div class="date">🕒 ${dateStr}</div>
      <div class="actions">
        <button onclick="like('${doc.id}')">👍 ${item.likes || 0}</button>
        <button onclick="dislike('${doc.id}')">👎 ${item.dislikes || 0}</button>
      </div>
      <div class="comments" id="comments-${doc.id}">
        <h4>Bình luận</h4>
        ${item.comments ? item.comments.map(c => `<p><b>${c.user}:</b> ${c.text}</p>`).join("") : ""}
        <input type="text" id="input-${doc.id}" placeholder="Viết bình luận...">
        <button onclick="addComment('${doc.id}')">Gửi</button>
      </div>
    `;
    return div;
  }

  // 👉 Realtime listener
  db.collection("dramas")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      contentDiv.innerHTML = ""; // clear
      if (snapshot.empty) {
        contentDiv.innerHTML = "<p style='text-align:center;color:#666'>Chưa có drama nào 😅</p>";
        return;
      }
      snapshot.forEach(doc => {
        contentDiv.appendChild(renderDrama(doc));
      });
    });

  // 👉 Like
  async function like(id) {
    const ref = db.collection("dramas").doc(id);
    await ref.update({ likes: firebase.firestore.FieldValue.increment(1) });
  }

  // 👉 Dislike
  async function dislike(id) {
    const ref = db.collection("dramas").doc(id);
    await ref.update({ dislikes: firebase.firestore.FieldValue.increment(1) });
  }

  // 👉 Comment
  async function addComment(id) {
    const input = document.getElementById("input-" + id);
    const text = input.value.trim();
    if (text !== "") {
      const ref = db.collection("dramas").doc(id);
      await ref.update({
        comments: firebase.firestore.FieldValue.arrayUnion({ user: "Khách", text })
      });
      input.value = "";
    }
  }
</script>

</body>
</html>
